{% extends 'catalog/base.html' %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block content %}
<div class="container px-4 py-5 mx-auto mb-5" style="max-width: 800px; min-height: 400px;">
   <div class="row d-flex justify-content-center">
      <h4 class="heading">Objednávka</h4>
   </div>
   {% if cart|length > 0 %}
   <div class="row d-flex py-2 justify-content-center border-top">
      {% for item in cart %}
      {% with product=item.product %}

      <div class="my-auto col-3">
            <div class="book">
               {% with first_photo=product.photos.first %}
               {% if first_photo %}
               <img src="{{ first_photo.photo.url }}" class="book-img" style="max-height: 100px; max-width: 50px;">

               {% endif %}
                {% endwith %}

            </div>
      </div>
      <div class="my-auto py-3 col-9">

         <div class="row text-right">
            <div class="col-6">
               <h6 class="mob-text">{{ product.name }}</h6>
            </div>
            <div class="col-6">
               <!-- Cart Remove Function--> 
                <div style="text-align: left;">
                  <form action="{% url 'cart:cart_remove' product.id %}" method="post">
                     {% csrf_token %}
                     <button type="submit" class="btn-close" aria-label="Close">
             
                     </button>
                  </form>
               </div>
            </div>
         </div>
         <form id="update-quantity-form-{{ forloop.counter }}" action="{% url 'cart:cart_add' item.product.id %}" method="post">
            {% csrf_token %}
            <div class="mob-text">
               <div class="row">
                  <div class="col-6">
                     <p id="zpusob_vyroby-{{ forloop.counter }}">Druh kolekce:</p>
                  </div>
                  <div class="col-6"  style="text-align: left;">
                     {{ item.update_quantity_form.zpusob_vyroby }}
                  </div>
               </div>
               <div class="row">
                  <div class="col-6">
                     <p class="mob-text" id="obvod_prsa-{{ forloop.counter }}">Velikost podprsenky:</p>
                  </div>
                  <div class="col-6"  style="text-align: left;">
                     {{ item.update_quantity_form.obvod_prsa }}
                  </div>
               </div>
               <div class="row">
                  <div class="col-6">
                     <p class="mob-text" id="obvod_hrudnik-{{ forloop.counter }}">Velikost pasu:</p>
                  </div>
                  <div class="col-6"  style="text-align: left;">
                     {{ item.update_quantity_form.obvod_hrudnik }}
                  </div>
               </div>
               <div class="row">
                  <div class="col-6">
                     <p class="mob-text" id="obvod_prsa-{{ forloop.counter }}">Velikost kalhotek:</p>
                  </div>
                  <div class="col-6"  style="text-align: left;">
                     {{ item.update_quantity_form.obvod_boky }}
                  </div>
               </div>
               <div class="row">
                  <div class="col-6">
                     <p class="mob-text" id="obvod_body-{{ forloop.counter }}">Velikost body:</p>
                  </div>
                  <div class="col-6"  style="text-align: left;">
                     {{ item.update_quantity_form.obvod_body }}
                  </div>
               </div>
               <div class="row">
                  <div class="col-6">
                     <p class="mob-text" id="obvod_boky-{{ forloop.counter }}">Poznámka:</p>
                  </div>
                  <div class="col-6"  style="text-align: left;">
                     {{ item.poznamka }}
                  </div>
               </div>
            </div>
            <div class="row text-right">
               <div id="update-quantity-code-{{ forloop.counter }} mb-0" class="col-6">
                  <div class="d-flex">
                     <div class="input-group">
                        <button class="btn btn-outline-dark rounded-0" name="update-quantity-form" type="button" onclick="decreaseCount({{ forloop.counter }})">
                           <i class="bi bi-dash" style="line-height: 1;"></i>
                        </button>
                        {{ item.update_quantity_form.quantity }}
                        {{ item.update_quantity_form.override }}
                        <button class="btn btn-outline-dark rounded-0" name="update-quantity-form" type="button" onclick="increaseCount({{ forloop.counter }})">
                           <i class="bi bi-plus" style="line-height: 1;"></i>
                        </button>
                     </div>
                  </div>
                  {% csrf_token %}
               </div>
               <div class="col-6">
                  <h6 class="mob-text">{{ item.total_price|intcomma }} Kč</h6>
               </div>
            </div>
         </form>

      </div>
   
      {% endwith %}
      {% endfor %}
      <div class="row d-flex py-2 justify-content-center border-top">
         <div class="row text-right" style="text-align: right;">
            <h6 class="mob-text">Total: {{ cart.get_total_price|intcomma }} Kč</h6>
         </div>
         {% if cart.coupon %}

         <div class="row text-right" style="text-align: right;">
            <h6 class="text-success" style="font-size:0.8rem">Slevový kupón  "{{ cart.coupon.code }}" ({{ cart.coupon.discount }}% off) -{{ cart.get_discount|intcomma }} Kč</h6>
         </div>
         <div class="row text-right" style="text-align: right;">
            <h6 class="mob-text">Total po slevě: {{ cart.get_total_price_after_discount|intcomma }} Kč</h6>
         </div>
         {% endif %}

      </div>
   </div>   

   <br>
   <div>
      


      {% if cart.coupon %}
 
      {% else %}
  

     
      <form class="card p-2" action="{% url 'coupons:apply' %}" method="post">
         <div class="input-group">
            {{ coupon_form }}
               <button type="submit" class="btn btn-secondary">Uplatnit</button>
     
         </div>
         {% csrf_token %}
      </form>


      {% endif %}


      

   </div>


   <section class="jumbotron text-center">
      <div class="container">
         <a href="{% url 'orders:new_order' %}" type="submit" class="btn btn-dark my-2">Koupit</a>
      </div>
   </section>

   {% else %}
   Prozatím zde nic není. Vyberte si z katalogu.
   {% endif %}
</div>







<script>
   // update-quantity-code
   function decreaseCount(counter) {
     var input = document.getElementById('id_quantity');
     var value = parseInt(input.value);
     if (value > 1) {
       input.value = value - 1;
     }
     updateQuantityForm(counter, input.value);
   }

   function increaseCount(counter) {
     var input = document.getElementById('id_quantity');
     var value = parseInt(input.value);
     input.value = value + 1;
     updateQuantityForm(counter, input.value);
   }

   function updateQuantityForm(counter, value) {
     var formId = 'update-quantity-form-' + counter;
     document.getElementById(formId).querySelector('#id_override').value = 'True';
     document.getElementById('obvod_hrudnik-' + counter).textContent = value;
     document.getElementById('obvod_prsa-' + counter).textContent = value;
     document.getElementById('obvod_boky-' + counter).textContent = value;
     document.getElementById('zpusob_vyroby-' + counter).textContent = value;
     document.getElementById(formId).submit();
   }
</script>

{% endblock %}