{% extends 'catalog/base.html' %}
{% load static %}
{% load i18n %}
{% load humanize %}
{% block content %}

<body data-new-gr-c-s-check-loaded="14.1107.0" data-gr-ext-installed="">


  <div class="container py-5">
      <!-- Shopping Cart Section -->
      <div class="row">
        <div class="col-md-4 order-md-2 mb-4">
          <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span>Váš nákupní košík</span>
            <span class="badge badge-secondary badge-pill">3</span>
          </h4>
          <ul class="list-group mb-3">
            {% for item in order.items.all %}
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <div class="d-flex align-items-center">

                {% with first_photo=item.product.photos.first %}
                {% if first_photo %}   
                <img src="{{ first_photo.photo.url }}" style="max-height: 70px; max-width: 27px; margin-right: 10px;">
                {% endif %}
                {% endwith %}
                <div>
                  <h6 class="my-0">{{ item.product.name }}       </h6>
                  <small class="text-muted">{{ order.zpusob_vyroby }}:</small>
                  <small class="text-muted">{{ order.obvod_prsa }}, </small>
                  <small class="text-muted">{{ order.obvod_hrudnik }}</small>





                </div>
              </div>
              <span>{{ item.get_cost|intcomma }} Kč</span>

            </li>
            {% endfor %}

            <li class="list-group-item d-flex justify-content-between lh-condensed">

              <span>Doprava: </span> 
              <strong> {{ order.shipping_price|intcomma }} Kč</strong>

              <!-- this is how to get shipping price-->
              <!-- <strong> {{ cart.get_shipping_price|intcomma }} Kč</strong> -->


          </li>
            <li class="list-group-item d-flex justify-content-between bg-light">
             
              <!-- #TODO total  to be calculated-->
               <span>Total: </span> 
               <strong>{{ order.get_total_cost|intcomma}} Kč</strong>
 
         
             </li>
          </ul>

        </div>
      </div>
  </div>


<!-- order summary -->
 
  <!-- Form Template -->
  <div class="col-md-8 order-md-1">
    <h4 class="mb-3">Objednávka</h4>
    <div class="form-group">
    <form id="update-order-form" class="needs-validation" novalidate="" method="post" action="#">
      {% csrf_token %}
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="firstName">Jméno    
          </label>
          {{ form.first_name }}
          <div class="invalid-feedback">
            Valid first name is required.
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <label for="lastName">
            Příjmení
          </label>
          {{ form.last_name }}
          <div class="invalid-feedback">
            Valid last name is required.
          </div>
        </div>
      </div>
      <div class="row">
      <div class="col-md-6 mb-3">
        <label for="email">E-mail</label>
        {{ form.email }}
                  <div class="invalid-feedback">
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <label for="email">Telefonní číslo</label>
        {{ form.number }}
                <div class="invalid-feedback">
        </div>
      </div>
      <div class="col-md-6 mb-3" id="countrySelected" onchange="updateOrderForm(this.value)"> <!--TODO this onchange is new-->
        <label for="email">Země</label>
        {{ form.country }} 
                <div class="invalid-feedback">
        </div>
      </div>

      <div class="mb-3" id="id_shipping" name="shipping">
        <label for="shipping">Doprava</label>
         {{ form.shipping }}

        <div class="invalid-feedback"></div>
      </div>
      
      <script>
        function showPacketaButton() {
          var selectElement = document.querySelector('form select[name="shipping"]');
          var selectedValue = selectElement.value;



          if (selectedValue === "Z") {
            var elementToShow = document.getElementById("packeta_button");
            elementToShow.style.display = "block";
          } else {
            var elementToHide = document.getElementById("packeta_button");
            elementToHide.style.display = "none";
          }
        }
        
        var selectElement = document.getElementById("id_shipping");
        selectElement.addEventListener("change", showPacketaButton);
      
        showPacketaButton();


      </script>
      <div class="mb-3">
        <!-- Packeta script-->
<script src="https://widget.packeta.com/v6/www/js/library.js"></script>

<!-- Add an element to display the selected country -->
<p id="selectedCountryDisplay"></p>

<!-- Your JavaScript code -->





<script>
const packetaApiKey = 'e2ac633a88eca5e2';

const packetaOptions = {
  valueFormat: "name, street, city"
};

function showSelectedPickupPoint(point) {
  // Add here an action on pickup point selection
  const saveElement = document.querySelector(".packeta-selector-value");
  const addressInput = document.querySelector("#id_address"); // invokes the variable 
  const vendorIdInput = document.querySelector("#id_vendor_id"); // invokes the variable 

  saveElement.innerText = '';
  if (point) {
    console.log("Selected point", point);
    saveElement.innerText = "ID: " + point.id; // this is showing variable output, but we don't need it
    addressInput.value = point.formatedValue; //saves the value to the form    
    vendorIdInput.value = point.id;      
  };
}

</script>

<button id="packeta_button" type="button" style="display: none;" class="btn btn-dark my-2 mb-4" onclick="Packeta.Widget.pick(packetaApiKey, showSelectedPickupPoint, packetaOptions)">Vyberte si místo vyzvednutí</button>    
<div class="packeta-selector-value"></div> 

<!-- End Packeta Script-->
      </div>

      {{ form.vendor_id }}


      <div class="col-md-6 mb-3">
        <label for="email">Adresa</label>
        {{ form.address }}
                <div class="invalid-feedback">
        </div>
        
    </div>
      <div class="mb-3">
        <label for="email">Komentáře</label>
        {{ form.comments }}
                  <div class="invalid-feedback">
        </div>
      </div>

      <section class="jumbotron text-center">
        <div class="container">


          <!-- BaCK BUTTON, would have to solve it using JS
          <a href="javascript:history.back()"><button class="btn btn-dark my-2 mb-4">Zpět</button></a>
          -->

<!--          <button class="btn btn-dark my-2 mb-4" type="submit">Objednat</button> -->
        </div>


        <!-- Payment Instructions -->
        <form method="post" action="{% url 'stripepayment:process' %}">
          <!-- Include the necessary form fields -->
          {% csrf_token %}        
          <!-- Add other form fields here -->
          <button class="btn btn-dark my-2 mb-4" action="https://secure.payu.com/api/v2_1/orders" type="submit">Platit</button>
        </form>
      <!--end Payment Instructions -->

      
      </section>

    </form>
    </div>
    
  </div>
  
  </div>
</div>




<!-- end order summary -->


  <form action="{% url 'stripepayment:process' %}" method="post">
    <input type="submit"  class="btn btn-dark my-2 mb-4" value="Pay now">
    {% csrf_token %}
</form>







  </div>



<div id="^(,rZvUx1683491487730"></div><iframe name="" frameborder="0" id="fnlp-panel-iframe" style="display: none!important; position: fixed!important; top: 0px!important; right: -280px!important; z-index: 1000000000!important; width: 305px!important; height: 100vh!important; margin:0!important; border: 0px!important; outline: 0px!important;"></iframe></body>

{% endblock %}